name: ü§ñ Deploy Appwarden on Cloudflare
on: workflow_dispatch
# 1Ô∏è‚É£ Uncomment the following lines to deploy the middleware on every release
# deploy the middleware on every release
# on:
#   release:
#     types: [published]
# 1Ô∏è‚É£ or, uncomment the following lines to deploy the middleware on a push to a specific branch
# on:
#   push:
#     branches:
#       - main

env:
  # 2Ô∏è‚É£ Configure your deployment:
  #    - CLOUDFLARE_ACCOUNT_ID: Your Cloudflare account ID (set as a variable in Github)
  #    - APPWARDEN_API_TOKEN & CLOUDFLARE_API_TOKEN: Add as secrets (https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions)
  #     - Create APPWARDEN_API_TOKEN in the [Appwarden dashboard](https://use.appwarden.io/?to=settings/monitoring)
  #     - Create CLOUDFLARE_API_TOKEN in the [Cloudflare dashboard](https://dash.cloudflare.com/profile/api-tokens) using the "Edit Cloudflare Workers" template
  CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
  APPWARDEN_API_TOKEN: ${{ secrets.APPWARDEN_API_TOKEN }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy-appwarden:
    name: Deploy Appwarden
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4

      # 3Ô∏è‚É£ Uncomment the following lines if you're using `npm`
      # - name: Setup npm
      #   run: npm ci --ignore-scripts

      # 3Ô∏è‚É£ Uncomment the following lines if you're using `yarn`
      # - name: Install dependencies
      #   run: yarn install --ignore-scripts

      # 3Ô∏è‚É£ Uncomment the following lines if you're using `pnpm`
      # - name: Setup pnpm
      #   uses: pnpm/action-setup@v4
      #   with:
      #     run_install: |
      #       - args: [--ignore-scripts]

      # This builds the Appwarden middleware for Cloudflare
      - name: Build @appwarden/middleware
        id: build
        uses: appwarden/build-cloudflare-action@v3
        with:
          debug: true
          cloudflare-account-id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          appwarden-api-token: ${{ env.APPWARDEN_API_TOKEN }}

      # This deploys the Appwarden middleware to Cloudflare
      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3.14.1
        env:
          APPWARDEN_API_TOKEN: ${{ env.APPWARDEN_API_TOKEN }}
        with:
          packageManager: npm # 4Ô∏è‚É£ add your package manager (e.g. npm, yarn, or pnpm)
          workingDirectory: .appwarden/generated-middleware
          environment: production
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          secrets: |
            APPWARDEN_API_TOKEN

      - name: Deployment successful
        run: |
          echo "::notice::‚úÖ Appwarden middleware v${{ steps.build.outputs.middlewareVersion }} deployed successfully to: ${{ steps.build.outputs.hostnames }} | View in Cloudflare dashboard: https://dash.cloudflare.com/${{ env.CLOUDFLARE_ACCOUNT_ID }}/workers-and-pages"
